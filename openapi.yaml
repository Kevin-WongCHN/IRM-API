openapi: 3.0.0
info:
  title: IRM Platform API
  description: |
    需求管理平台 (IRM-Platform) 后端接口定义文档。
    基于 PostgreSQL 数据库设计，涵盖项目管理、目录管理、文档管理及需求对象管理。
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
servers:
  - url: http://localhost:8080
    description: 本地开发环境
  - url: https://api.irm-platform.com/v1
    description: 生产环境

tags:
  - name: 需求定义
    description: 需求和文档的借口
  - name: 项目管理
    description: 项目管理相关接口
  - name: 基线管理
    description: 基线管理相关接口
  - name: 在线评审
    description: 在线评审相关接口
  - name: 需求确认
    description: 需求确认相关接口
  - name: 需求验证
    description: 需求验证相关接口
  - name: 变更管理
    description: 变更管理相关接口
  - name: 文件管理
    description: 文件上传与下载接口


paths:
  # ==========================================
  # 文件管理 API
  # ==========================================
  /api/files/upload:
    post:
      tags: [文件管理]
      summary: 上传文件 (图片等)
      consumes:
        - multipart/form-data
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: 上传成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    description: 文件的访问URL
                  filename:
                    type: string
                    description: 存储的文件名

  /api/files/{filename}:
    get:
      tags: [文件管理]
      summary: 获取文件
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功返回文件流
          content:
            image/*:
              schema:
                type: string
                format: binary
        '404':
          description: 文件未找到

  # ==========================================
  # 项目管理 API
  # ==========================================
  /api/projects:
    get:
      tags: [项目管理]
      summary: 获取项目列表
      description: 分页获取项目列表，支持按名称或状态过滤。
      parameters:
        - name: page
          in: query
          description: 页码 (默认1)
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          description: 每页数量 (默认20)
          schema:
            type: integer
            default: 20
        - name: keyword
          in: query
          description: 搜索关键字 (项目名或代号)
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [项目管理]
      summary: 创建新项目
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreateDto'
      responses:
        '201':
          description: 项目创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/projects/{id}:
    get:
      tags: [项目管理]
      summary: 获取项目详情
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [项目管理]
      summary: 更新项目信息
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreateDto'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [项目管理]
      summary: 删除项目
      description: 删除项目及其关联的所有目录、文档和对象（级联删除）。
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 删除成功，无内容返回
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================
  # 目录管理 API (隶属于项目)
  # ==========================================
  /api/projects/{projectId}/directories:
    get:
      tags: [项目管理]
      summary: 获取项目的目录列表
      description: 获取指定项目下的所有目录结构。
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Directory'

  /api/directories:
    post:
      tags: [项目管理]
      summary: 创建目录
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DirectoryCreateDto'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Directory'

  /api/directories/{id}:
    delete:
      tags: [项目管理]
      summary: 删除目录
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 删除成功

  # ==========================================
  # 文档管理 API (需求定义)
  # ==========================================
  /api/projects/{projectId}/documents:
    get:
      tags: [需求定义]
      summary: 获取项目下的文档列表
      description: 支持按目录ID筛选。
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: directoryId
          in: query
          description: 可选，按目录筛选
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Document'

  /api/documents:
    post:
      tags: [需求定义]
      summary: 创建新文档
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentCreateDto'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  /api/documents/{documentId}/import/docx:
    post:
      tags: [需求定义]
      summary: 导入 DOCX 文档
      description: 解析 DOCX 文件并将内容作为对象插入到指定文档中
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: 导入成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    description: 导入的对象数量
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/documents/{id}:
    get:
      tags: [需求定义]
      summary: 获取文档元数据
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [需求定义]
      summary: 更新文档元数据
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentCreateDto'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [需求定义]
      summary: 删除文档
      description: 将级联删除文档下的所有对象。
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 删除成功

  /api/documents/{documentId}/import/docx:
    post:
      tags: [需求定义]
      summary: 导入Word文档
      description: 将Word文档内容导入到指定文档中
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: 导入成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReqObject'

  # ==========================================
  # 对象(需求条目)管理 API (需求定义)
  # ==========================================
  /api/documents/{documentId}/objects:
    get:
      tags: [需求定义]
      summary: 获取文档的所有对象（需求条目）
      description: 获取文档内的所有对象。默认返回树形结构或按 child_order 排序的列表。
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: format
          in: query
          description: 返回格式 (tree 或 list)
          schema:
            type: string
            enum: [tree, list]
            default: list
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReqObject'

  /api/objects:
    post:
      tags: [需求定义]
      summary: 创建单个对象
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReqObjectCreateDto'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReqObject'

  /api/objects/batch:
    post:
      tags: [需求定义]
      summary: 批量创建对象
      description: 用于导入或快速创建多个需求条目。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ReqObjectCreateDto'
      responses:
        '200':
          description: 批量创建成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReqObject'

  /api/objects/{id}:
    put:
      tags: [需求定义]
      summary: 更新对象内容或属性
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReqObjectUpdateDto'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReqObject'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [需求定义]
      summary: 删除对象
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 删除成功

components:
  parameters:
    IdParam:
      name: id
      in: path
      description: 资源的唯一ID
      required: true
      schema:
        type: integer
        format: int64

  responses:
    BadRequest:
      description: 请求参数错误 (400)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: 资源未找到 (404)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: 服务器内部错误 (500)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    # ----------------------
    # 通用错误响应
    # ----------------------
    ErrorResponse:
      type: object
      properties:
        code:
          type: integer
          example: 400
        message:
          type: string
          example: "Invalid parameter"
        details:
          type: string
          description: 详细错误堆栈或提示

    # ----------------------
    # 项目 (Project)
    # ----------------------
    Project:
      type: object
      properties:
        projectId:
          type: integer
          format: int64
        projectName:
          type: string
        projectCode:
          type: string
        manager:
          type: string
        department:
          type: string
        projectScale:
          type: string
          enum: [小型, 中型, 大型, 超大型]
        projectLevel:
          type: string
          enum: [P0 紧急, P1 重要, P2 常规, P3 低优先级]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        state:
          type: string
          maxLength: 10
          description: 项目状态

    ProjectCreateDto:
      type: object
      required: [projectName, projectCode, manager, department, projectScale, projectLevel, startDate, endDate]
      properties:
        projectName:
          type: string
          maxLength: 100
        projectCode:
          type: string
          maxLength: 50
        manager:
          type: string
        department:
          type: string
        projectScale:
          type: string
          enum: [小型, 中型, 大型, 超大型]
        projectLevel:
          type: string
          enum: [P0 紧急, P1 重要, P2 常规, P3 低优先级]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        state:
          type: string
          maxLength: 10
          description: 项目状态

    # ----------------------
    # 目录 (Directory)
    # ----------------------
    Directory:
      type: object
      properties:
        directoryId:
          type: integer
          format: int64
        projectId:
          type: integer
          format: int64
        directoryPath:
          type: string
          description: 目录的完整路径

    DirectoryCreateDto:
      type: object
      required: [projectId, directoryPath]
      properties:
        projectId:
          type: integer
          format: int64
        directoryPath:
          type: string
          maxLength: 1024

    # ----------------------
    # 文档 (Document)
    # ----------------------
    Document:
      type: object
      properties:
        documentId:
          type: integer
          format: int64
        projectId:
          type: integer
          format: int64
        directoryId:
          type: integer
          format: int64
        documentName:
          type: string
        filePrefix:
          type: string
        documentProperties:
          type: object
          description: 任意 JSON 结构的文档属性
          example: { "status": "draft", "author": "admin" }

    DocumentCreateDto:
      type: object
      required: [projectId, directoryId, documentName, filePrefix]
      properties:
        projectId:
          type: integer
          format: int64
        directoryId:
          type: integer
          format: int64
        documentName:
          type: string
          maxLength: 255
        filePrefix:
          type: string
          maxLength: 100
        documentProperties:
          type: object

    # ----------------------
    # 对象/需求 (Object)
    # ----------------------
    ReqObject:
      type: object
      properties:
        objectId:
          type: integer
          format: int64
        documentId:
          type: integer
          format: int64
        parentObjectId:
          type: integer
          format: int64
          nullable: true
          description: 父对象ID，为空表示根节点
        childOrder:
          type: integer
          description: 排序号
        objectType:
          type: string
          enum: [rich_text, picture, heading, diagram]
          description: 对象内容的类型
        objectContent:
          type: string
          description: HTML 内容或资源 URL
        version:
          type: string
        editable:
          type: boolean
          default: true
          description: 是否可编辑
        objectProperties:
          type: object
          description: 扩展属性（如自定义字段值）

    ReqObjectCreateDto:
      type: object
      required: [documentId, objectType, objectContent, version]
      properties:
        documentId:
          type: integer
          format: int64
        parentObjectId:
          type: integer
          format: int64
          nullable: true
        childOrder:
          type: integer
          default: 0
        objectType:
          type: string
          enum: [rich_text, picture, heading, diagram]
        objectContent:
          type: string
        version:
          type: string
        editable:
          type: boolean
          default: true
        objectProperties:
          type: object

    ReqObjectUpdateDto:
      type: object
      properties:
        objectContent:
          type: string
        version:
          type: string
        childOrder:
          type: integer
        editable:
          type: boolean
        objectProperties:
          type: object